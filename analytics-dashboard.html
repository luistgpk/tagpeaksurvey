<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagpeak Survey Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.skypack.dev/@supabase/supabase-js@2"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">
                ðŸ“Š Tagpeak Survey Analytics
            </h1>
            <p class="text-lg text-gray-600">Real-time insights for partner presentations</p>
            <div class="mt-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <i class="fas fa-circle text-green-500 mr-2"></i>
                    Live Data
                </span>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold mb-2" id="total-responses">-</div>
                <div class="text-lg opacity-90">Total Responses</div>
            </div>
            <div class="metric-card rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold mb-2" id="avg-indifference">-</div>
                <div class="text-lg opacity-90">Avg Discount Threshold</div>
            </div>
            <div class="metric-card rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold mb-2" id="tagpeak-preference">-</div>
                <div class="text-lg opacity-90">Tagpeak Preference</div>
            </div>
            <div class="metric-card rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold mb-2" id="comprehension-rate">-</div>
                <div class="text-lg opacity-90">Understanding Rate</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Psychology Profile Distribution -->
            <div class="chart-container rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Psychology Profile Distribution</h3>
                <div id="psychology-chart" class="h-64 flex items-center justify-center">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Demographics Breakdown -->
            <div class="chart-container rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Demographics Breakdown</h3>
                <div id="demographics-chart" class="h-64 flex items-center justify-center">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Partner Insights -->
        <div class="chart-container rounded-2xl p-6 shadow-lg mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Partner-Ready Insights</h3>
            <div id="partner-insights" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="brand-affinity">-</div>
                    <div class="text-sm text-gray-600">Brand Affinity Score</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="purchase-intent">-</div>
                    <div class="text-sm text-gray-600">Purchase Intent</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="innovation-adoption">-</div>
                    <div class="text-sm text-gray-600">Innovation Adoption</div>
                </div>
            </div>
        </div>

        <!-- Recent Responses -->
        <div class="chart-container rounded-2xl p-6 shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Responses</h3>
            <div id="recent-responses" class="space-y-2">
                <div class="text-gray-500">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Simple password protection
        const DASHBOARD_PASSWORD = 'tagpeak2024..'; // Change this password
        
        function checkAccess() {
            const password = prompt('Enter dashboard password:');
            if (password !== DASHBOARD_PASSWORD) {
                alert('Access denied');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }
        
        // Check access on page load
        if (!checkAccess()) {
            document.body.innerHTML = '<div class="text-center p-8"><h1>Access Denied</h1></div>';
        }

        // Initialize Supabase
        let supabase = null;
        
        const initializeSupabase = async () => {
            try {
                const { createClient } = await import('https://unpkg.com/@supabase/supabase-js@2/dist/main.js');
                supabase = createClient(
                    'https://mevruhsacqhcqrylcwje.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ldnJ1aHNhY3FoY3FyeWxjd2plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDg1MjcsImV4cCI6MjA3NDk4NDUyN30._42ZLdMK9ml3fVdwLmk7slxO05-sXZyyv8ByDvt1yL4'
                );
                console.log('Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Supabase initialization failed:', error);
                return false;
            }
        };

        // Load analytics data
        async function loadAnalytics() {
            try {
                if (!supabase) {
                    await initializeSupabase();
                }
                
                if (!supabase) {
                    throw new Error('Failed to initialize Supabase');
                }
                
                console.log('Fetching survey responses...');
                const { data, error } = await supabase
                    .from('survey_responses')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Database query error:', error);
                    throw error;
                }
                
                console.log('Survey responses fetched:', data?.length || 0, 'records');

                // Show data count
                const dataCount = data?.length || 0;
                console.log(`Found ${dataCount} survey responses`);
                
                if (dataCount === 0) {
                    const contentArea = document.getElementById('content-area');
                    if (contentArea) {
                        contentArea.innerHTML = `
                            <div class="text-center p-8">
                                <h1 class="text-2xl font-bold text-blue-600 mb-4">No Data Yet</h1>
                                <p class="text-gray-600 mb-4">No survey responses found in the database.</p>
                                <p class="text-sm text-gray-500">Complete the survey to see analytics data here.</p>
                                <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    Refresh
                                </button>
                            </div>
                        `;
                    }
                    return;
                }
                
                updateMetrics(data);
                updateCharts(data);
                updatePartnerInsights(data);
                updateRecentResponses(data);

            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('total-responses').textContent = 'Error';
            }
        }

        function updateMetrics(data) {
            const totalResponses = data.length;
            const avgIndifference = data.reduce((sum, response) => {
                const points = Object.values(response.indifference_points || {});
                const avg = points.reduce((s, p) => s + parseFloat(p.point || 0), 0) / points.length;
                return sum + (avg || 0);
            }, 0) / totalResponses;

            const tagpeakPreference = data.filter(response => {
                const points = Object.values(response.indifference_points || {});
                const avg = points.reduce((s, p) => s + parseFloat(p.point || 0), 0) / points.length;
                return avg < 25; // Prefer Tagpeak if threshold < 25%
            }).length / totalResponses * 100;

            const comprehensionRate = data.filter(response => {
                const answers = response.shopping_behavior?.comprehension_answers || {};
                const correct = Object.values(answers).filter(a => a.isCorrect).length;
                return correct >= 2; // 2 out of 3 correct
            }).length / totalResponses * 100;

            document.getElementById('total-responses').textContent = totalResponses;
            document.getElementById('avg-indifference').textContent = avgIndifference ? avgIndifference.toFixed(1) + '%' : '-';
            document.getElementById('tagpeak-preference').textContent = tagpeakPreference ? tagpeakPreference.toFixed(1) + '%' : '-';
            document.getElementById('comprehension-rate').textContent = comprehensionRate ? comprehensionRate.toFixed(1) + '%' : '-';
        }

        function updateCharts(data) {
            // Psychology Profile Chart
            const psychologyData = {};
            data.forEach(response => {
                const profile = response.psychology_profile || {};
                const key = `${profile.riskTolerance || 'Unknown'}-${profile.timePreference || 'Unknown'}`;
                psychologyData[key] = (psychologyData[key] || 0) + 1;
            });

            const psychologyChart = document.getElementById('psychology-chart');
            psychologyChart.innerHTML = Object.entries(psychologyData)
                .map(([key, count]) => `<div class="text-sm">${key}: ${count}</div>`)
                .join('');

            // Demographics Chart
            const demographicsData = {};
            data.forEach(response => {
                const demo = response.demographics || {};
                const age = demo.age;
                if (age) {
                    const range = age < 25 ? '18-24' : age < 35 ? '25-34' : age < 45 ? '35-44' : age < 55 ? '45-54' : '55+';
                    demographicsData[range] = (demographicsData[range] || 0) + 1;
                }
            });

            const demographicsChart = document.getElementById('demographics-chart');
            demographicsChart.innerHTML = Object.entries(demographicsData)
                .map(([range, count]) => `<div class="text-sm">${range}: ${count}</div>`)
                .join('');
        }

        function updatePartnerInsights(data) {
            const insights = data.reduce((acc, response) => {
                const analytics = response.shopping_behavior?.enhanced_analytics || {};
                acc.brandAffinity += analytics.brandAffinity || 0;
                acc.purchaseIntent += analytics.purchaseIntent || 0;
                acc.innovationAdoption += analytics.innovationAdoption || 0;
                return acc;
            }, { brandAffinity: 0, purchaseIntent: 0, innovationAdoption: 0 });

            const count = data.length;
            document.getElementById('brand-affinity').textContent = count ? (insights.brandAffinity / count * 100).toFixed(1) + '%' : '-';
            document.getElementById('purchase-intent').textContent = count ? (insights.purchaseIntent / count * 100).toFixed(1) + '%' : '-';
            document.getElementById('innovation-adoption').textContent = count ? (insights.innovationAdoption / count * 100).toFixed(1) + '%' : '-';
        }

        function updateRecentResponses(data) {
            const recent = data.slice(0, 5);
            const container = document.getElementById('recent-responses');
            container.innerHTML = recent.map(response => {
                const points = Object.values(response.indifference_points || {});
                const avg = points.reduce((s, p) => s + parseFloat(p.point || 0), 0) / points.length;
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium">Response ${response.user_id.slice(-8)}</div>
                            <div class="text-sm text-gray-600">Threshold: ${avg ? avg.toFixed(1) + '%' : 'N/A'}</div>
                        </div>
                        <div class="text-sm text-gray-500">${new Date(response.created_at).toLocaleDateString()}</div>
                    </div>
                `;
            }).join('');
        }

        // Initialize and load analytics
        (async () => {
            const success = await initializeSupabase();
            if (success) {
                console.log('Testing database connection...');
                try {
                    const { data, error } = await supabase
                        .from('survey_responses')
                        .select('count')
                        .limit(1);
                    
                    if (error) {
                        console.error('Database connection test failed:', error);
                        document.getElementById('content-area').innerHTML = `
                            <div class="text-center p-8">
                                <h1 class="text-2xl font-bold text-red-600 mb-4">Database Connection Error</h1>
                                <p class="text-gray-600">Unable to connect to the database. Error: ${error.message}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    console.log('Database connection successful');
                    loadAnalytics();
                    setInterval(loadAnalytics, 30000);
                } catch (err) {
                    console.error('Database test error:', err);
                    document.getElementById('content-area').innerHTML = `
                        <div class="text-center p-8">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Database Error</h1>
                            <p class="text-gray-600">Error: ${err.message}</p>
                        </div>
                    `;
                }
            } else {
                document.getElementById('content-area').innerHTML = `
                    <div class="text-center p-8">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">Supabase Initialization Failed</h1>
                        <p class="text-gray-600">Unable to initialize Supabase client</p>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>
